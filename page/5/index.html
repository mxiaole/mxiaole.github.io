<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Pisces","version":"7.7.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="人生识字忧患始，不待扬鞭自奋蹄">
<meta property="og:url" content="http://yoursite.com/page/5/index.html">
<meta property="og:site_name" content="人生识字忧患始，不待扬鞭自奋蹄">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Cody">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/page/5/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false
  };
</script>

  <title>人生识字忧患始，不待扬鞭自奋蹄</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">人生识字忧患始，不待扬鞭自奋蹄</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-right"></div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/27/docker%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cody">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="人生识字忧患始，不待扬鞭自奋蹄">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/04/27/docker%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">docker学习笔记</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-04-27 14:31:37" itemprop="dateCreated datePublished" datetime="2019-04-27T14:31:37+08:00">2019-04-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-02-18 13:36:53" itemprop="dateModified" datetime="2020-02-18T13:36:53+08:00">2020-02-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index">
                    <span itemprop="name">工具</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="0-安装docker"><a href="#0-安装docker" class="headerlink" title="0. 安装docker"></a>0. 安装docker</h1><p>ubuntu环境下安装：<code>sudo apt install docker-io</code><br>centos上安装：<a href="https://docs.docker.com/install/linux/docker-ce/centos/" target="_blank" rel="noopener">https://docs.docker.com/install/linux/docker-ce/centos/</a> 参考官方文档完成安装即可</p>
<p><strong>将用户添加到docker用户组：<code>gpasswd -M mxiaole docker  将mxiaole用户添加到docker组</code></strong></p>
<blockquote>
<p>vagrant + virtualbox使用：借助该工具可以直接在virtualbox中创建虚拟机</p>
<ul>
<li>首先安装virtualbox和vagrant：下载地址<a href="https://www.vagrantup.com/downloads.html和https://www.virtualbox.org/wiki/Downloads" target="_blank" rel="noopener">https://www.vagrantup.com/downloads.html和https://www.virtualbox.org/wiki/Downloads</a></li>
<li>使用vagrant快速的创建Linux虚拟机：<ul>
<li>创建一个目录centos，然后cd到该目录，执行<code>vagrant init centos/7</code>命令，会生成一个Vagrantfile文件</li>
<li>然后运行<code>vagrant up</code>命令，之后就会创建好了一个虚拟机</li>
<li>连接到生成的虚拟机：<code>vagrant ssh</code></li>
</ul>
</li>
<li>vagrant的其他命令：vagrant status、vagrant halt、vagrant destroy</li>
</ul>
</blockquote>
<h1 id="1-docker-machine使用"><a href="#1-docker-machine使用" class="headerlink" title="1. docker-machine使用"></a>1. docker-machine使用</h1><p>这个工具可以用来创建远端的docker server，但是要有相关的驱动，然后在本地使用docker-machine命令就可以在virtual-box, vm-ware, aws，aliyun上使用相应的驱动创建安装了docker的虚拟机。</p>
<p>使用virtualbox驱动直接创建一个安装了docker的虚拟机：<code>docker-machine create 虚拟机的名字</code><br>直接进入创建好的虚拟机：<code>docker-machine ssh 虚拟机的名字</code><br>docker-machine 的其他命令，使用docker-manchine –help 查看</p>
<blockquote>
<p>tips<br>可以使用mac上的client 连接docker-machine创建的安装了docker的虚拟机，在终端执行如下的两条命令：<br><code>docker-machine env 虚拟机的名字</code>  ,  <code>eval ($docker-machine env 虚拟机的名字)</code><br>撤销使用的命令： <code>docker-machine env --unset</code>, <code>eval $(docker-machine env --unset)</code></p>
</blockquote>
<p>dockerplayground可以随意的玩</p>
<h1 id="2-基本概念"><a href="#2-基本概念" class="headerlink" title="2. 基本概念"></a>2. 基本概念</h1><h2 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h2><p><img src="docker%E6%9E%B6%E6%9E%84%E5%9B%BE.jpeg" alt="docker架构图"></p>
<p>共享宿主机的kernel</p>
<h2 id="docker使用的底层技术主要有："><a href="#docker使用的底层技术主要有：" class="headerlink" title="docker使用的底层技术主要有："></a>docker使用的底层技术主要有：</h2><ul>
<li>namespace实现隔离. <a href="https://coolshell.cn/articles/17010.html" target="_blank" rel="noopener">详细了解参考</a></li>
<li>cgroup实现资源限制</li>
<li>union file systems实现container和image分层</li>
</ul>
<p>这些技术都是Linux上自带的。</p>
<h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><ul>
<li><strong>镜像image</strong>: 在docker中，所有的应用程序都被制作成了镜像</li>
<li><strong>容器container</strong>: 每一个基于镜像的应用程序都必须在容器中才能执行</li>
<li><strong>宿主机</strong>: 运行docker这个应用程序的机器称为宿主机</li>
</ul>
<p>镜像的分层概念。</p>
<h1 id="3-image"><a href="#3-image" class="headerlink" title="3. image"></a>3. image</h1><h2 id="3-1-是什么"><a href="#3-1-是什么" class="headerlink" title="3.1 是什么"></a>3.1 是什么</h2><ul>
<li>是文件和meta data的集合。</li>
<li>分层，每一层都可以添加删除改变文件，称为一个新的image</li>
<li>不同的image可以共享相同的layer</li>
<li>image本身是只读的</li>
</ul>
<h2 id="3-2-怎么操作"><a href="#3-2-怎么操作" class="headerlink" title="3.2 怎么操作"></a>3.2 怎么操作</h2><p><strong>1. 获取image</strong></p>
<p>有三种获取image的方法：</p>
<ul>
<li>自己创建dockerfile文件，进行构建image: docker build -t imagename:tag .</li>
<li>基于container创建一个image: docker container commit (不推荐使用)</li>
<li>直接从镜像仓库中获取: docker pull imagename</li>
</ul>
<p><strong>2. 发布image</strong></p>
<p><strong>发布到dockerhub</strong></p>
<ul>
<li><p>创建一个docker hub账号，被push的image的name必须是<code>dockerhubID/imagename[:tag]</code></p>
</li>
<li><p>在发布之前必须先登录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker login</span><br><span class="line">docker image push mxiaole/hello-world:latest</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>推荐的做法是将dockerhub和github进行关联，在github上发布dockerfile，然后dockerhub会自动的根据dockerfile创建image</p>
<p><strong>发布到私有的dockerhub</strong></p>
<ul>
<li>使用docker创建一个私有的dockerhub: <code>docker run -d -p 5000:5000 --restart always --name registry registry:2</code></li>
<li>向本地私有仓库提交image的时候，镜像的名字必须是<code>10.10.10.2:8888/hello</code>, registry的IP:端口，开头</li>
<li>然后，使用命令<code>dockr push 10.10.2:888/hello</code>向本地仓库push镜像，但是这个时候可能会出错，<ul>
<li>在/etc/docker/目录下创建一个文件:daemon.json，添加内容<code>{&quot;insecure-registries&quot;: [&quot;10.0.2.15:500&quot;]}</code></li>
<li>同时在/lib/systemd/system/docker.service文件中添加一行: <code>EnvironmenFile=-/etc/docker/daemon.json</code></li>
<li>最后重启docker：<code>sudo service docker restart</code></li>
</ul>
</li>
<li>验证镜像是否成功的push： <code>curl localhost:5000/v2/_catlog</code> 查看</li>
</ul>
<h1 id="4-创建image"><a href="#4-创建image" class="headerlink" title="4. 创建image"></a>4. 创建image</h1><h2 id="4-1-基于container创建image"><a href="#4-1-基于container创建image" class="headerlink" title="4.1 基于container创建image"></a>4.1 基于container创建image</h2><p><code>docker commit containername newimage</code> 使用上述的命令能够基于已经存在的container创建一个新的image</p>
<h2 id="4-2-使用Dockerfile创建image"><a href="#4-2-使用Dockerfile创建image" class="headerlink" title="4.2 使用Dockerfile创建image"></a>4.2 使用Dockerfile创建image</h2><p>Dockerfile常用的命令：</p>
<ul>
<li><p>FROM: 指定创建image的base image是什么 ; 尽量使用官方的image作为baseimage</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos</span><br></pre></td></tr></table></figure></li>
<li><p>LABEL: </p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">LABEL</span><span class="bash"> maintainer=<span class="string">"mxiaole"</span></span></span><br><span class="line"><span class="keyword">LABEL</span><span class="bash"> version=<span class="string">"1.0"</span></span></span><br><span class="line"><span class="keyword">LABEL</span><span class="bash"> description=<span class="string">"this is description"</span></span></span><br></pre></td></tr></table></figure></li>
<li><p>RUN:  创建镜像时执行的命令，每运行一次该命令，就会生成新的一层; 将多条命令放在一行，如果需要换行使用\</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="bash"> yum install vim &amp;&amp; yum install git &amp;&amp; yum install gcc</span></span><br></pre></td></tr></table></figure>
<p><strong>命令有两种格式，cmd和entrypoint命令也是如此</strong></p>
<ul>
<li>shell格式<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="bash"> apt install -y vim</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"hello world"</span></span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"hello world"</span></span></span><br></pre></td></tr></table></figure></li>
<li>exec格式<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="bash"> [<span class="string">"apt"</span>, <span class="string">"install"</span>, <span class="string">"-y"</span>, <span class="string">"vim"</span>]</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"/bin/echo"</span>, <span class="string">"hello world"</span>]</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">"/bin/echo"</span>, <span class="string">"hello world"</span>]</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>CMD: 设置容器启动之后默认执行的命令和参数, 如果在docker run的时候执行了其他的命令，那么cmd命令会被忽略；如果定义了多个cmd命令，只有最后一个会被执行。</p>
</li>
<li><p>ENTRYPOINT: 设置容器启动时执行的命令；让容器以应用程序或者服务的形式运行；该命令不会被忽略,docker run 指定的启动命令作为参数传递给它设置的命令；最好是写一个shell脚本作为entrypoint</p>
</li>
<li><p>WORKDIR: 用来设定当前的工作目录; 尽量是用绝对路径，不要使用相对路径</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /root</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> demo</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">pwd</span>  <span class="comment"># 输出结果应该是/root/demo</span></span></span><br></pre></td></tr></table></figure></li>
<li><p>ADD &amp;&amp; COPY: 这两个命令都是将本地的文件，添加到docker image中<br><strong>两者的区别</strong>:</p>
<ul>
<li>ADD命令还可以进行解压: ADD xxx.tar.gz /</li>
<li>大部分的情况优先使用COPY</li>
</ul>
</li>
<li><p>ENV: 用来设定环境变量</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ENV</span> MYSQL_VERSION <span class="number">5.7</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum install mysql=<span class="variable">$&#123;MYSQL_VERSION&#125;</span></span></span><br></pre></td></tr></table></figure></li>
<li><p>VOLUME: 指定当前容器中要备份的文件路径，会将docker container中该路径下的文件挂载到宿主机上的某个位置。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">VOLUME</span><span class="bash"> /var/lib/mysql</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="4-3-demo"><a href="#4-3-demo" class="headerlink" title="4.3 demo"></a>4.3 demo</h2><p><strong>demo1: 创建一个Python的flask应用</strong></p>
<ul>
<li>创建dockerfile<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> python:<span class="number">2.7</span></span><br><span class="line"><span class="keyword">LABEL</span><span class="bash"> maintainer=<span class="string">"mxiale"</span></span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip install flask</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> main.py /app/</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"python"</span>, <span class="string">"main.py"</span>]</span></span><br></pre></td></tr></table></figure></li>
<li>build镜像文件 : <code>docker build -t mxiaole/flask-demo .</code></li>
<li>运行创建的镜像：<code>docker run -d mxiaole/flask-demo</code></li>
</ul>
<p><strong>使用dockerfile创建image时的debug</strong><br>因为在build的时候，每一层都会生成一个镜像，可以通过运行这些中间生成的镜像来进行debug</p>
<p><strong>demo2: 创建一个命令行工具</strong></p>
<ul>
<li>创建dockerfile<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu</span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt update &amp;&amp; apt install stress</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">"/usr/bin/stress/"</span>]</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> []</span></span><br></pre></td></tr></table></figure></li>
<li>创建镜像：<code>docker build -t mxiaole/ubuntu-stress .</code></li>
<li>使用: <code>docker run -it mxiaole/ubuntu-stress --help</code> 可以直接指定stress的命令参数</li>
</ul>
<h1 id="5-container操作"><a href="#5-container操作" class="headerlink" title="5. container操作"></a>5. container操作</h1><h2 id="5-1-启动容器"><a href="#5-1-启动容器" class="headerlink" title="5.1 启动容器"></a>5.1 启动容器</h2><p>最简单的启动方式就是：<code>docker run image</code>。容器的生命周期：运行时，运行结束后退出。</p>
<h2 id="其他命令"><a href="#其他命令" class="headerlink" title="其他命令"></a>其他命令</h2><ul>
<li>exec命令: <code>docker exec -it conainerid /bin/bash</code> 进入一个运行的容器</li>
<li>inspect: <code>docker inspect conainerid</code> 检测一个container的信息</li>
<li>logs: <code>docker logs containerid</code> 查看container的输出日志</li>
</ul>
<blockquote>
<p>tips: 快速清除多个container<br>docker container ls -aq  # 查看容器的ID<br>docker rm $(docker container ls -aq)  # 可以实现快速的删除多个container<br>docker container ls -f “status=exited” -q  # 查看所有的已经退出的container<br>docker rm $(docker container ls -f “status=exited” -q)  # 快速的清除所有已经退出的container</p>
</blockquote>
<h1 id="6-网络管理"><a href="#6-网络管理" class="headerlink" title="6. 网络管理"></a>6. 网络管理</h1><p><img src="docker%E7%BD%91%E7%BB%9C.png" alt="docker网络"></p>
<p>Docker使用Linux桥接，在宿主机上虚拟一个Docker网桥。Docker在启动一个容器时会根据Docker网桥的网段分配容器的IP，同时Docker网桥是每个容器的默认网关。</p>
<p>Docker网桥是宿主机虚拟出来的，并不是真实存在的网络设备，外部网络无法寻址到，如果希望容器能够被外部网络访问到，就需要通过映射容器端口到宿主机的端口</p>
<h1 id="7-数据持久化"><a href="#7-数据持久化" class="headerlink" title="7. 数据持久化"></a>7. 数据持久化</h1><p>Docker中的数据持久化：使用Docker数据卷将宿主机上的文件或者目录挂载到容器中。</p>
<p><strong>如果使用容器，启动一个myql，当这个container销毁后，如果MySQL中的数据保存在container中，那么MySQL中的数据也会消失；这时候应该怎么处理呢？</strong></p>
<p>将宿主机上的目录或者文件挂载到容器中，即使容器销毁，数据卷中的数据仍然保留在宿主机上，下次启动的时候可以使用。</p>
<p>共有两种 Volume 类型。每种 Volume 都是宿主机上的的一个目录对应到container内的一个目录，其不同只在于主机上的位置。</p>
<p>第 1 种叫绑定挂载的 Volume (bind mount volume)：用户<strong>指定将主机上的某个目录</strong>挂载到<strong>容器中的某个目录</strong>。(-v参数指定，宿主机的目录：container的目录， 这两个目录是一一对应的)， 在运行container的时候，直接使用-v参数指定。</p>
<p>第 2 种叫受管理的 Volume (managed volume)：所使用的主机上的位置是由 Docker daemon 创建并管理的，这些位置称为 Docker managed space, 在dockerfile文件中使用VOLUME指令指定volume的路径，然后使用-v参数给这个volume起个名字, 这个volume对应的宿主机的位置不是用户指定的，是docker运行时自动指定的。</p>
<p>例如：创建一个MySQL container: <code>docker run -d --name mysql -e MYSQL_ALLOW_EMPTY_PASSWORD=true mysql</code>, 这时候查看一下<code>docker volume ls</code>会看到生成了一个volume，使用<code>docker volume inspect volumenameid</code>命令可以查看详情</p>
<p>上面的命令创建的container生成的volumeID不方便使用，可以使用<code>docker run -d -v mysql:/var/lib/mysql --name mysql -e MYSQL_ALLOW_EMPTY_PASSWORD=true mysql</code>创建（-v参数指定volume的名字），当把创建的MySQL container销毁之后，下一次启动一个新的container(<code>docker run -d -v mysql:/var/lib/mysql --name mysql2 -e MYSQL_ALLOW_EMPTY_PASSWORD=true mysql</code>)的时候可以继续通过volume的名字指定使用销毁的container的volume。</p>
<p>上述命令中的<code>-v</code>参数：指定生成的volume名字，前面的参数是volume名字:后面的是容器中备份文件的路径，</p>
<p><strong>demo: bind mount使用</strong></p>
<p>考虑这样一个场景：假如我们只有mac环境，但是我们在Mac上安装了docker。我们想要使用Mac的pycharm ide开发了一个Flask项目，我们可以创建一个Dockerfile，然后将这个项目创建一个镜像，然后运行这个镜像到container中。但是突然发现我们还有一个功能没有开发，这时候会频繁的修改Flask项目中的文件，如果我们每做一次修改就要重新build创建一个镜像，然后运行，实在是太麻烦了，这个时候我们可以考虑使用这个bind mount神器。具体操作如下：</p>
<ul>
<li>将初次的项目，创建一个镜像，然后运行的时候使用-v参数：<code>docker run -p 5000:5000 -d --name flask -v $(pwd):/root/flask mxiaole/myflask</code></li>
<li>之后，可以在Mac上修改项目文件，这些文件或自动的同步到container中</li>
</ul>
<p><strong>demo2: wordpress搭建</strong></p>
<ul>
<li>docker run -d –name mysql -v mysql-data:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=root -e MYSQL_DATABASE=wordpress mysql:5.7</li>
<li>docker run -d -e WORDPRESS_DB_HOST=mysql:3306 –link mysql -p 8080:80 wordpress</li>
</ul>
<h1 id="8-docker-compose"><a href="#8-docker-compose" class="headerlink" title="8. docker-compose"></a>8. docker-compose</h1><p>如果我们想要创建一个Python项目，这个Python项目依赖MySQL和Redis和Nginx，这时候需要手动的创建这些container，为了减少复杂度，我们可以将这些container创建成一个组，将这些容器进行统一的启动，删除等操作。docker-compose就是为了解决这个问题的。</p>
<p>注意：该方式不适合在生产环境使用</p>
<h2 id="8-1-使用"><a href="#8-1-使用" class="headerlink" title="8.1 使用"></a>8.1 使用</h2><p>基本的使用流程：创建一个docker-compose.yaml文件，然后使用docker-compose进行操作。</p>
<p><strong>命令</strong></p>
<ul>
<li>docker-compose up</li>
<li>docker-compose images</li>
<li>docker-compose ps</li>
<li>docker-compose exec </li>
</ul>
<h2 id="8-2-docker-compose-yml文件"><a href="#8-2-docker-compose-yml文件" class="headerlink" title="8.2 docker-compose.yml文件"></a>8.2 docker-compose.yml文件</h2><p>可以直接指定镜像启动，也可以通过在compose文件中使用build命令在文件中先build镜像，然后在启动镜像。</p>
<p>docker-compose.yaml文件, 该文件主要有三个基本的概念：service，networks，volumes.</p>
<p><strong>services</strong>：一个service代表一个container，可以给service指定network和volume</p>
<p>水平扩展：<code>docker-compose up --scale web=3  -d</code>, 该命令只能实现单机上的扩容，无法实现多个物理机器上的扩容，如果想要扩容还需要使用swarm</p>
<h1 id="9-swarm容器编排"><a href="#9-swarm容器编排" class="headerlink" title="9. swarm容器编排"></a>9. swarm容器编排</h1><p>在集群中管理docker镜像</p>
<h2 id="9-1-基础"><a href="#9-1-基础" class="headerlink" title="9.1 基础"></a>9.1 基础</h2><p>物理机两个角色：manager 和 worker。swarm集群的初始化：<code>docker swarm init --advertise-addr=想要做manager的节点ip</code>，初始化manager节点</p>
<p>集群相关的命令：<code>docker node</code></p>
<p>在docker swarm集群中创建service不在使用<code>docker run</code>命令，而是使用<code>docker service create</code>命令.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">create      Create a new service  # 创建一个服务</span><br><span class="line">inspect     Display detailed information on one or more services</span><br><span class="line">logs        Fetch the logs of a service or task</span><br><span class="line">ls          List services</span><br><span class="line">ps          List the tasks of one or more services</span><br><span class="line">rm          Remove one or more services</span><br><span class="line">rollback    Revert changes to a service's configuration</span><br><span class="line">scale       Scale one or multiple replicated services  # 横向扩展服务</span><br><span class="line">update      Update a service</span><br></pre></td></tr></table></figure>

<h2 id="9-2-swarm中的docker-compose"><a href="#9-2-swarm中的docker-compose" class="headerlink" title="9.2 swarm中的docker-compose"></a>9.2 swarm中的docker-compose</h2><p>首先创建docker-compose文件，然后使用命令<code>docker stack</code>命令来部署服务</p>
<h2 id="9-2-实践"><a href="#9-2-实践" class="headerlink" title="9.2 实践"></a>9.2 实践</h2><p>使用docker-machine命令创建三个安装了docker的虚拟机.<br>1.前提条件：</p>
<ul>
<li>安装了docker-machine工具</li>
<li>安装了virtual-box驱动</li>
</ul>
<p>2.安装</p>
<p>依次执行命令：<code>docker-machine create swarm-manager</code>, <code>docker-machine create swarm-worker1</code>, <code>docker-machine create swarm-worker2</code></p>
<p>3.初始化</p>
<ul>
<li>登录要作为manager的主机：<code>docker-machine ssh swarm-manager</code>, 然后执行命令: <code>docker swarm init --advertise-addr=192.168.99.101</code>，之后会得到<code>docker swarm join --token SWMTKN-1-0etbagd0a455sx2b7bu0va69qhdqzti8bc7hhqohi7rzm29lus-ekf933f62naxe37s52bk64umq 192.168.99.101:2377</code></li>
<li>登录worker机器：分别执行上面的命令输出的命令<code>docker swarm join --token SWMTKN-1-0etbagd0a455sx2b7bu0va69qhdqzti8bc7hhqohi7rzm29lus-ekf933f62naxe37s52bk64umq 192.168.99.101:2377</code></li>
<li>检查集群的状态：登录manager节点，执行<code>docker node ls</code>命令</li>
</ul>
<p>4.部署wordpress服务</p>
<ul>
<li>在manager节点上创建一个overlay驱动的网络: <code>docker network create -d overlay demo</code></li>
<li>在manager节点上创建MySQL服务: <code>docker service create --name mysql --env MYSQL_ROOT_PASSWORD=root --env MYSQL_DATABASE=wordpress --network demo --mount type=volume,source=mysql-data,destination=/var/lib/mysql mysql:5.7</code></li>
<li>在manager节点上创建wordpress服务：<code>docker service create --name wordpress -p 80:80 --env WORDPRESS_DB_PASSWORD=root --env WORDPRESS_DB_HOST=mysql --network demo wordpress</code></li>
</ul>
<h2 id="9-3-swarm中的密码管理Dockersecret"><a href="#9-3-swarm中的密码管理Dockersecret" class="headerlink" title="9.3 swarm中的密码管理Dockersecret"></a>9.3 swarm中的密码管理Dockersecret</h2><p><strong>创建</strong><br>使用<code>docker secret create</code>命令来创建secret，可以从标准输入来创建，也可以从文件来创建。</p>
<ul>
<li><code>docker secret create secret名字  文件名</code></li>
<li><code>echo &quot;*****&quot; | docker secret create secretname  -</code>  </li>
</ul>
<p><strong>使用</strong></p>
<ul>
<li><p>在命令行中使用：在创建container的时候通过–secret参数来指定secret, 然后会被保存在container上的/run/secrets目录下。例如使用MySQL密码使用：在创建container的时候可以使用如下的命令：<br><code>docker service create --name mysql --secret secretname -e MYSQL_ROOT_PASSWORD_FILE=/run/secrets/secretname mysql:5.7</code></p>
</li>
<li><p>在docker-compose文件中使用: 可以使用secret标签先创建然后使用, 也可以先手动创建然后service中直接使用。推荐采用后者。<br>方式1：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">aaa:</span></span><br><span class="line">    <span class="string">xxxxx</span> </span><br><span class="line">  </span><br><span class="line">  <span class="attr">secrect:</span></span><br><span class="line">    <span class="attr">my-pwd:</span></span><br><span class="line">      <span class="attr">file:</span> <span class="string">./password</span></span><br></pre></td></tr></table></figure>
<p>方式2：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:5.7</span></span><br><span class="line">    <span class="attr">secret:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">my-pwd</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="9-4-docker-swarm-service的更新"><a href="#9-4-docker-swarm-service的更新" class="headerlink" title="9.4 docker swarm service的更新"></a>9.4 docker swarm service的更新</h2><p>在不停服的情况下对server进行更新：首先将service进行水平扩展<code>docker service scale server_container_name=2</code>, 然后使用命令<code>docker service update --image new_image_name server_container_name</code></p>
<p>通过端口更新, 这样会导致业务的中断：<code>docker service update --publish-rm 8080:5050 --publish-add 9999:5050 container-name</code></p>
<p>对于通过docker-compose文件创建的service的更新，需要直接修改docker-compose文件，然后重新执行docker stack deploy。</p>
<blockquote>
<p>参考文章<br>1.<a href="https://docs.docker.com/engine/reference/commandline/cli/" target="_blank" rel="noopener">https://docs.docker.com/engine/reference/commandline/cli/</a><br>2.《Docker进阶与实战》<br>3.<a href="https://docs.docker.com/compose/compose-file/" target="_blank" rel="noopener">https://docs.docker.com/compose/compose-file/</a></p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/25/kafka%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cody">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="人生识字忧患始，不待扬鞭自奋蹄">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/04/25/kafka%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">kafka权威指南笔记</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-04-25 19:39:03" itemprop="dateCreated datePublished" datetime="2019-04-25T19:39:03+08:00">2019-04-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-12-07 13:10:09" itemprop="dateModified" datetime="2019-12-07T13:10:09+08:00">2019-12-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%8E%E5%8F%B0%E5%BC%80%E5%8F%91/" itemprop="url" rel="index">
                    <span itemprop="name">后台开发</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="1-基本概念"><a href="#1-基本概念" class="headerlink" title="1 基本概念"></a>1 基本概念</h4><ul>
<li>消息：kafka的数据单元</li>
<li>主题：kafka中的每个消息都属于一个<code>主题</code></li>
<li>分区：分区是消息存储的物理单元，一个主题中的消息，通过<code>分区器</code>的作用存储在不同的分区中。<code>同一个主题的多个分区，可能分布在不同的机器上</code>。</li>
<li>生产者：将一个消息发送到某个主题的分区中</li>
<li>消费者：消费者消费分区中的消息，通过<code>偏移量</code>来保证顺序消费某个分区中的消息。</li>
<li>消费者群组：消费者是以消费者群组的形式存在的，消费者群组中有一个或者多个消费者，一个指定的消费者群组会订阅一个主题。群组保证每个分区只能被一个消费者使用。</li>
<li>broker：一个部署了kafka服务的服务器被称为一个broker。每个集群中都会有一个充当集群控制器的broker。在集群中一个分区从属于一个broker，该broker被称为分区的<code>首领</code>。一个分区可以分配给多个broker。</li>
<li>保留消息：kfka通过某种策略来对消息进行保留。</li>
</ul>
<h4 id="2-kafka的特性"><a href="#2-kafka的特性" class="headerlink" title="2 kafka的特性"></a>2 kafka的特性</h4><ul>
<li>多个消费者：与其他的消息队列不同，消息一旦被一个客户端读取，其他的客户端就无法在读取它。kafka的消息可以被多个消费者读取。</li>
<li>基于磁盘的数据存储：kafka允许消费者，非实时的进行消息的读取。消息被提交到磁盘，根据设置的保留规则进行保存。每个主题都可以设置单独的保留规则</li>
</ul>
<h4 id="3-安装和部署"><a href="#3-安装和部署" class="headerlink" title="3 安装和部署"></a>3 安装和部署</h4><p>kakfa使用zookeeper来保存集群的<code>元数据</code>信息和消费者消息。<br>使用进行安装部署，docker-compose.yml文件内容入如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'2.1'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">zookeeper:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">wurstmeister/zookeeper</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">"2181"</span></span><br><span class="line">  <span class="attr">kafka:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">wurstmeister/kafka</span> </span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">"9092"</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">KAFKA_ADVERTISED_HOST_NAME:</span>  <span class="number">192.168</span><span class="number">.2</span><span class="number">.10</span> <span class="comment">#宿主机的ip地址</span></span><br><span class="line">      <span class="attr">KAFKA_ZOOKEEPER_CONNECT:</span> <span class="string">zookeeper:2181</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/var/run/docker.sock:/var/run/docker.sock</span></span><br></pre></td></tr></table></figure>

<h4 id="4-kafka生产者"><a href="#4-kafka生产者" class="headerlink" title="4 kafka生产者"></a>4 kafka生产者</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoCallBack</span> <span class="keyword">implements</span> <span class="title">Callback</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompletion</span><span class="params">(RecordMetadata metadata, Exception exception)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (exception != <span class="keyword">null</span>) &#123;</span><br><span class="line">                exception.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生产者, 向kafka集群中发送message</span></span><br><span class="line"><span class="comment">     * produce向集群push消息</span></span><br><span class="line"><span class="comment">     * 可以同步的向集群发送消息，也可以异步的发送消息</span></span><br><span class="line"><span class="comment">     * 怎么确定将消息发送到哪个partition上呢？</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Producer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.put(<span class="string">"bootstrap.servers"</span>, <span class="string">"127.0.0.1:32796, 127.0.0.1:32797, 127.0.0.1:32798"</span>);  <span class="comment">// consumer连接到broker集群</span></span><br><span class="line">        properties.put(<span class="string">"acks"</span>, <span class="string">"all"</span>);  <span class="comment">// 指定消息发送的模式，all</span></span><br><span class="line">        properties.put(<span class="string">"retries"</span>, <span class="number">0</span>);</span><br><span class="line">        properties.put(<span class="string">"batch.size"</span>, <span class="number">16384</span>);</span><br><span class="line">        properties.put(<span class="string">"linger.ms"</span>, <span class="number">1</span>);</span><br><span class="line">        properties.put(<span class="string">"buffer.memory"</span>, <span class="number">33554432</span>);</span><br><span class="line">        properties.put(<span class="string">"key.serializer"</span>, <span class="string">"org.apache.kafka.common.serialization.StringSerializer"</span>);</span><br><span class="line">        properties.put(<span class="string">"value.serializer"</span>, <span class="string">"org.apache.kafka.common.serialization.StringSerializer"</span>);</span><br><span class="line"></span><br><span class="line">        Producer&lt;String, String&gt; producer = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            producer = <span class="keyword">new</span> KafkaProducer&lt;&gt;(properties);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">                String msg = <span class="string">"Message "</span> + i;</span><br><span class="line">                <span class="comment">/*指定发送的topic*/</span></span><br><span class="line">                producer.send(<span class="keyword">new</span> ProducerRecord&lt;String, String&gt;(<span class="string">"test1"</span>, msg), <span class="keyword">new</span> DemoCallBack());  <span class="comment">// 指定要发送的topic和消息体</span></span><br><span class="line">                System.out.println(<span class="string">"Sent:"</span> + msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-kafka消费者"><a href="#5-kafka消费者" class="headerlink" title="5 kafka消费者"></a>5 kafka消费者</h4><p><img src="kafka_jiagou.jpg" alt="kafka架构简图"></p>
<blockquote>
<p>参考文章</p>
<ol>
<li><a href="https://tomoyadeng.github.io/blog/2018/06/02/kafka-cluster-in-docker/index.html" target="_blank" rel="noopener">https://tomoyadeng.github.io/blog/2018/06/02/kafka-cluster-in-docker/index.html</a></li>
</ol>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/21/sql%E6%B3%A8%E5%85%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cody">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="人生识字忧患始，不待扬鞭自奋蹄">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/04/21/sql%E6%B3%A8%E5%85%A5/" class="post-title-link" itemprop="url">sql注入</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2019-04-21 08:00:57 / Modified: 10:08:02" itemprop="dateCreated datePublished" datetime="2019-04-21T08:00:57+08:00">2019-04-21</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" itemprop="url" rel="index">
                    <span itemprop="name">渗透测试</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h4><p>使用ubuntu搭建dvwa1.9进行SQL注入测试, 安全级别设置为low。</p>
<h4 id="1-SQL注入原理"><a href="#1-SQL注入原理" class="headerlink" title="1 SQL注入原理"></a>1 SQL注入原理</h4><p>首先，我们应该清楚我们进行SQL注入的目的是什么，怎么通过SQL注入来达到我们的目的。另外，了解常见的SQL注入常用的方式，手动注入和使用工具如SQLmap进行自动注入。SQL注入的危害主要有如下：</p>
<ul>
<li>猜解后台数据库，就是通过常用的SQL注入语句，一点点的将数据库中存在的数据库，表，表中的字段给破解，获取数据库的详细信息</li>
<li>绕过认证，没有用户名和密码的情况下能够直接登录网站</li>
<li>可以借助数据库的存储过程进行提权</li>
</ul>
<h4 id="2-实战-猜解后台数据库"><a href="#2-实战-猜解后台数据库" class="headerlink" title="2 实战-猜解后台数据库"></a>2 实战-猜解后台数据库</h4><h5 id="基本思路"><a href="#基本思路" class="headerlink" title="基本思路"></a>基本思路</h5><ul>
<li><p>判断目标是否存在SQL注入漏洞，如果存在注入，那么注入是字符型还是数字型</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">通常存在SQL注入的url一般具有特定的格式，如：http:&#x2F;&#x2F;xxx.xxx.xxx&#x2F;abcd.php?id&#x3D;XX，在如php，jsp，asp动态网页中且此网页访问了数据库常存在SQL注入。</span><br><span class="line">常用单引号的方法来判断是否存在SQL注入，因为单引号会造成数据库单引号个数不匹配的异常。</span><br></pre></td></tr></table></figure>
</li>
<li><p>拆解SQL查询语句中的字段数</p>
</li>
<li><p>确定显示的字段顺序</p>
</li>
<li><p>获取当前数据库</p>
</li>
<li><p>获取数据库中的表</p>
</li>
<li><p>获取表中的字段名</p>
</li>
<li><p>下载数据</p>
</li>
</ul>
<h4 id="实战详解"><a href="#实战详解" class="headerlink" title="实战详解"></a>实战详解</h4><blockquote>
<p>参考：<br><a href="https://www.jianshu.com/p/078df7a35671" target="_blank" rel="noopener">https://www.jianshu.com/p/078df7a35671</a></p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/20/es%E6%93%8D%E4%BD%9C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cody">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="人生识字忧患始，不待扬鞭自奋蹄">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/04/20/es%E6%93%8D%E4%BD%9C/" class="post-title-link" itemprop="url">ElasticSearch学习</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-04-20 16:05:30" itemprop="dateCreated datePublished" datetime="2019-04-20T16:05:30+08:00">2019-04-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-04-23 08:27:45" itemprop="dateModified" datetime="2019-04-23T08:27:45+08:00">2019-04-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%8E%E5%8F%B0%E5%BC%80%E5%8F%91/" itemprop="url" rel="index">
                    <span itemprop="name">后台开发</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="1-入门基础"><a href="#1-入门基础" class="headerlink" title="1. 入门基础"></a>1. 入门基础</h4><h5 id="1-1-安装部署"><a href="#1-1-安装部署" class="headerlink" title="1.1 安装部署"></a>1.1 安装部署</h5><p>在物理机上部署：官网下载es，然后直接解压，执行bin/elasticsearch，通过指定-d参数可以实现后台启动。<br>也可以采用docker进行部署，<a href="https://www.jianshu.com/p/fdfead5acc23" target="_blank" rel="noopener">参考地址</a></p>
<h5 id="1-2-基本概念"><a href="#1-2-基本概念" class="headerlink" title="1.2 基本概念"></a>1.2 基本概念</h5><p>es中存储的是文档，这些文档是使用json进行序列化的。<code>文档</code>可以理解为关系型数据库中的<code>行记录</code>，es中的<code>索引</code>可以理解为关系型数据库中的<code>数据库</code>，<code>类型</code>可以理解为关系型数据库中的<code>表</code>。</p>
<h4 id="2-es-restful-api简单操作"><a href="#2-es-restful-api简单操作" class="headerlink" title="2. es restful api简单操作"></a>2. es restful api简单操作</h4><ul>
<li><p>创建索引: <code>curl -X PUT &quot;localhost:9200/索引名字&quot;</code></p>
</li>
<li><p>删除索引：<code>curl -X DELETE &#39;localhost:9200/索引的名字&#39;</code></p>
</li>
<li><p>查看es中的所有索引: <code>curl -XGET &#39;localhost:9200/_cat/indices?v&amp;pretty&#39;</code></p>
</li>
<li><p>插入文档</p>
  <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -X PUT 'localhost:9200/accounts/person/1' -d '</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"user"</span>: <span class="string">"张三"</span>,</span><br><span class="line">    <span class="attr">"title"</span>: <span class="string">"工程师"</span>,</span><br><span class="line">    <span class="attr">"desc"</span>: <span class="string">"数据库管理"</span></span><br><span class="line">&#125;'</span><br></pre></td></tr></table></figure>

<p>  上述api中: accounts表示索引的名字，person表示类型的名字，1表示带插入的文档的id。也可以不指定id但是要使用post发送请求，如下</p>
  <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST 'localhost:9200/accounts/person' -d '</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"user"</span>: <span class="string">"李四"</span>,</span><br><span class="line">    <span class="attr">"title"</span>: <span class="string">"工程师"</span>,</span><br><span class="line">    <span class="attr">"desc"</span>: <span class="string">"系统管理"</span></span><br><span class="line">&#125;'</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询指定索引中的指定类型的某个id的文档数据</p>
  <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl 'localhost:9200/accounts/person/1?pretty=true'</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询指定索引的指定类型的所有的文档数据</p>
  <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl 'localhost:9200/accounts/person/_search?pretty=true'</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除指定id的文档</p>
  <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X DELETE 'localhost:9200/accounts/person/1'</span><br></pre></td></tr></table></figure>
</li>
<li><p>更新文档</p>
  <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -X PUT 'localhost:9200/accounts/person/1' -d '</span><br><span class="line">&#123;</span><br><span class="line">    "user" : "张三",</span><br><span class="line">    "title" : "工程师",</span><br><span class="line">    "desc" : "数据库管理，软件开发"</span><br><span class="line">&#125;'</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="3-查询详解"><a href="#3-查询详解" class="headerlink" title="3 查询详解"></a>3 查询详解</h4><h5 id="查询字符串搜索"><a href="#查询字符串搜索" class="headerlink" title="查询字符串搜索"></a>查询字符串搜索</h5><p>就是在查询的语句中使用q进行参数传递</p>
<h5 id="DSL搜索"><a href="#DSL搜索" class="headerlink" title="DSL搜索"></a>DSL搜索</h5><h4 id="2-java-api"><a href="#2-java-api" class="headerlink" title="2. java api"></a>2. java api</h4><h4 id="3-python-api"><a href="#3-python-api" class="headerlink" title="3. python api"></a>3. python api</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> elasticsearch <span class="keyword">import</span> Elasticsearch</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ESManager</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    elasticsearch操作类</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, hosts)</span>:</span></span><br><span class="line">        self.client = Elasticsearch(hosts=hosts)</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">search</span><span class="params">(self, index, body=None)</span>:</span></span><br><span class="line">        res = self.client.search(index, body)</span><br><span class="line">        hits = res[<span class="string">"hits"</span>][<span class="string">"hits"</span>]</span><br><span class="line">        <span class="keyword">return</span> json.dumps(hits, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">query_one_by_id</span><span class="params">(self, index, id, _type)</span>:</span></span><br><span class="line">        res = self.client.get(index, id, _type)</span><br><span class="line">        source = res[<span class="string">"_source"</span>]</span><br><span class="line">        <span class="keyword">return</span> source</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">query_many_by_ids</span><span class="params">(self, ids: list, doc_type: str, index: str)</span> -&gt; iter:</span></span><br><span class="line">        body = &#123;<span class="string">"ids"</span>: ids&#125;</span><br><span class="line">        res = self.client.mget(body, doc_type, index)</span><br><span class="line">        docs = res[<span class="string">"docs"</span>]</span><br><span class="line">        <span class="keyword">for</span> doc <span class="keyword">in</span> docs:</span><br><span class="line">            source = doc[<span class="string">"_source"</span>]</span><br><span class="line">            <span class="keyword">yield</span> json.dumps(source, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    node = [<span class="string">"localhost:9200"</span>]</span><br><span class="line"></span><br><span class="line">    client = ESManager(node)</span><br><span class="line">    body = &#123;</span><br><span class="line">        <span class="string">"query"</span>: &#123;</span><br><span class="line">            <span class="string">"bool"</span>: &#123;</span><br><span class="line">                <span class="string">"must"</span>: [</span><br><span class="line">                    &#123;<span class="string">"match"</span>: &#123;<span class="string">"title"</span>: <span class="string">"Search"</span>&#125;&#125;,</span><br><span class="line">                    &#123;<span class="string">"match"</span>: &#123;<span class="string">"content"</span>: <span class="string">"Elasticsearch"</span>&#125;&#125;</span><br><span class="line">                ],</span><br><span class="line">                <span class="string">"filter"</span>: [</span><br><span class="line">                    &#123;<span class="string">"term"</span>: &#123;<span class="string">"status"</span>: <span class="string">"published"</span>&#125;&#125;,</span><br><span class="line">                    &#123;<span class="string">"range"</span>: &#123;<span class="string">"publish_date"</span>: &#123;<span class="string">"gte"</span>: <span class="string">"2015-01-01"</span>&#125;&#125;&#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 查询多条</span></span><br><span class="line">    res = client.search(<span class="string">"books"</span>, body)</span><br><span class="line">    res = client.search(<span class="string">"books"</span>)</span><br><span class="line">    <span class="comment"># print(res)</span></span><br><span class="line">    <span class="comment"># 根据id查询</span></span><br><span class="line">    <span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">    res = client.query_one_by_id(<span class="string">"books"</span>, <span class="string">"Cx1nCWQB-ZDs_wiUraqf"</span>, <span class="string">"novel"</span>)</span><br><span class="line">    <span class="comment"># print(res)</span></span><br><span class="line">    id_list = [<span class="string">"Cx1nCWQB-ZDs_wiUraqf"</span>, <span class="string">"BB1nCWQB-ZDs_wiUraqL"</span>, <span class="string">"FB1nCWQB-ZDs_wiUraq3"</span>]</span><br><span class="line">    a = time.time()</span><br><span class="line">    res = client.query_many_by_ids(id_list, <span class="string">"novel"</span>, <span class="string">"books"</span>)</span><br><span class="line">    print(time.time() - a)</span><br><span class="line">    <span class="keyword">for</span> r <span class="keyword">in</span> res:</span><br><span class="line">        print(r)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>参考文章<br><a href="https://blog.csdn.net/ax8785r8C32nef593/article/details/78988443" target="_blank" rel="noopener">https://blog.csdn.net/ax8785r8C32nef593/article/details/78988443</a></p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/20/lua%E7%BC%96%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cody">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="人生识字忧患始，不待扬鞭自奋蹄">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/04/20/lua%E7%BC%96%E7%A8%8B/" class="post-title-link" itemprop="url">lua编程</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2019-04-20 15:42:49 / Modified: 17:22:04" itemprop="dateCreated datePublished" datetime="2019-04-20T15:42:49+08:00">2019-04-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index">
                    <span itemprop="name">编程语言</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a href="https://github.com/andycai/luaprimer/blob/master/01.md" target="_blank" rel="noopener">参考</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/18/python%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cody">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="人生识字忧患始，不待扬鞭自奋蹄">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/04/18/python%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/" class="post-title-link" itemprop="url">python深入理解</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-04-18 09:00:51" itemprop="dateCreated datePublished" datetime="2019-04-18T09:00:51+08:00">2019-04-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-04-23 08:28:16" itemprop="dateModified" datetime="2019-04-23T08:28:16+08:00">2019-04-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index">
                    <span itemprop="name">编程语言</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="1-python的编译结果"><a href="#1-python的编译结果" class="headerlink" title="1. python的编译结果"></a>1. python的编译结果</h4><h5 id="1-1-python程序的执行程"><a href="#1-1-python程序的执行程" class="headerlink" title="1.1 python程序的执行程"></a>1.1 python程序的执行程</h5><p>python文件的执行是通过<code>解释器</code>来执行的。当敲入python命令的时候，目的就是为了激活解释器，在真正开始执行之前，python解释器要首先编译.py文件，通过编译得到python的<code>字节码.pyc</code>文件，然后将编译的字节码<code>.pyc</code>文件交给python<code>虚拟机</code>，虚拟机按<br>照顺序一条条的执行字节码。在.py文件进行编译之后除了产生.pyc文件，还会产生其他的一些信息。<br>在.pyc文件中保存的是.py源代码中出现的一切有用的<code>静态信息</code>，在python运行期间这些静态信息会被存储在一个<code>运行时的对象</code>中。<strong>当python运行结束后，这个运行对象中包含的信息会存储在pyc文件中</strong>。这个运行时的对象就是<code>PyCodeObject</code>。</p>
<blockquote>
<p>在程序运行期间，编译结果存在于内存的PyCodeObject对象中，而python运行结束后，编译结果保存在pyc文件中。当下一次运行相同的程序时，python会根据pyc文件中记录的编译结果直接建立内存中的PyCodeObject对象，不用在对源文件进行编译了。</p>
</blockquote>
<h5 id="PyCodeObject对象"><a href="#PyCodeObject对象" class="headerlink" title="PyCodeObject对象"></a>PyCodeObject对象</h5><p><strong>对于源代码中的一个<code>code block</code>，python编译器在对源代码进行编译的时候就会创建一个<code>PyCodeObject对象</code>与这个代码块进行对应。</strong> 那么一个code block是多少代码呢？当进入一个新的名字或者作用域时，就算是进入了一个新的code block。如下的代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># demo.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fun</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line">a = A()</span><br><span class="line">func()</span><br></pre></td></tr></table></figure>

<p>上述的代码会产生三个PyCodeObject对象：一个对应demo.py文件，一个对应class A代表的code block，最后一个是fun所对应的code block。</p>
<h5 id="名字空间"><a href="#名字空间" class="headerlink" title="名字空间"></a>名字空间</h5><p>名字空间是符号的上下文环境，名字空间可以一个套一个形成一个<code>名字空间链</code>。python虚拟机在执行的时候，会有很大一部分时间消耗在从这条名字空间链中确定一个<code>符号所应该对应的对象</code>是什么。在python中，类、函数、module都对应着一个独立的名字空间。名字空间实际上式维护这变量名和变量值之间关系的PyDictObject。</p>
<h4 id="1-2-pyc文件"><a href="#1-2-pyc文件" class="headerlink" title="1.2 pyc文件"></a>1.2 pyc文件</h4><p>每一个PyCodeObject对象中，都包含每一个code block中所有的python源代码经过编译后得到的byte code序列。</p>
<h5 id="import机制与pyc文件生成"><a href="#import机制与pyc文件生成" class="headerlink" title="import机制与pyc文件生成"></a>import机制与pyc文件生成</h5><p>python中的import会触发pyc文件的生成。python在运行的时候，碰到import abc这样的语句，那么python将到设定好的path中国寻找abc.pyc文件，如果没有找到，而只是找到了abc.py文件，那么python首先将abc.py编译成PyCodeObjct中间结果，然后创建abc.pyc文件，并将中间结果写入该文件。之后才会对abc.pyc文件执行import动作。</p>
<h5 id="pyc文件的内容"><a href="#pyc文件的内容" class="headerlink" title="pyc文件的内容"></a>pyc文件的内容</h5><p>pyc文件主要包含了三部分独立的信息：</p>
<ul>
<li>python的magic number，该信息是用来保证python的兼容性的。python在加载pyc文件的时候，会首先检查这个值，如果python自身的magic number与待加载的pyc文件中记录的该值不一致，就会拒绝加载该文件。</li>
<li>pyc文件的创建时间信息，如果我们修改了生成pyc文件的原文件，那么python在加载的时候会发现pyc文件时间早于py文件的时间，于是会重新编译pyc文件的原文件，生成新的pyc文件</li>
<li>PyCodeObject对象</li>
</ul>
<h5 id="python字节码指令"><a href="#python字节码指令" class="headerlink" title="python字节码指令"></a>python字节码指令</h5><p>使用dis标准库来解析code对象，查看code对象里的字节码指令信息。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">s = open(<span class="string">"aa.py"</span>).read()</span><br><span class="line">co = compile(s, <span class="string">"aa.py"</span>, <span class="string">"exec"</span>)</span><br><span class="line"><span class="keyword">import</span> dis</span><br><span class="line">dis.dis(co)</span><br></pre></td></tr></table></figure>

<p>示例如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># test.py</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">10</span>, <span class="number">2</span>):</span><br><span class="line">    print(i)</span><br></pre></td></tr></table></figure>

<p>执行如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>s = open(<span class="string">"test.py"</span>).read()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>co = compile(s, <span class="string">"test.py"</span>, <span class="string">"exec"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> dis</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>dis.dis(co)</span><br><span class="line"> <span class="number">18</span>    <span class="number">0</span> LOAD_CONST     <span class="number">0</span> (<span class="string">'\n@Time : 2018/1/11 09:17\n'</span>)  </span><br><span class="line">       <span class="number">2</span> STORE_NAME     <span class="number">0</span> (__doc__)</span><br><span class="line"> <span class="number">20</span>    <span class="number">4</span> SETUP_LOOP     <span class="number">28</span> (to <span class="number">34</span>)</span><br><span class="line">       <span class="number">6</span> LOAD_NAME      <span class="number">1</span> (range)</span><br><span class="line">       ...</span><br></pre></td></tr></table></figure>

<p>其中的，最左边的一列表示的是在源文件中的行号，第二列显示当前的字节码指令的偏移位置，第三列显示的是当前字节码指令，最后一列显示的是当前字节码指令的参数</p>
<h4 id="2-python虚拟机框架"><a href="#2-python虚拟机框架" class="headerlink" title="2 python虚拟机框架"></a>2 python虚拟机框架</h4><p>python字节码虚拟机的执行原理：python的虚拟机会从编译得到的PyCodeObject对象中依次读取每一条字节码指令，并在当前的上下文环境中执行这条字节码指令。python虚拟机实际上是模拟操作系统运行可执行文件的过程，即函数栈帧执行原理（对一个函数而言所有的局部变量的操作都是在<code>自己的栈帧</code>中完成的，而函数之间的调用则通过<code>创建新的栈帧</code>来完成），从而完成了python字节码指令序列的执行。</p>
<p>举例说明执行过程，有如下的代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">i = <span class="string">"Python"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span><span class="params">()</span>:</span></span><br><span class="line">    i = <span class="number">9999</span></span><br><span class="line">    print(i)</span><br><span class="line"></span><br><span class="line">f()</span><br><span class="line">print(i)</span><br></pre></td></tr></table></figure>

<p>上述代码的执行过程，可以描述如下：在运行第一条表达式的时候，python已经建立了一个<code>执行环境A</code>，所有的字节码指令都会在这个函数中执行，python可以从这个环境中获取变量的值，也可以根据字节码的指令修改执行环境中某个变量的值，以影响后序字节码指令，这个过程会一直执行下去，直到发生了函数调用，当函数在执行环境中调用f的字节码指令时，会在当前环境之外重新创建一个新的执行环境B。这个执行环境就是PyFrameObject对象。</p>
<p>在python实际的执行中会产生很多的PyFrameObject对象，这些对象是被链接起来的，形成一条执行环境链表。</p>
<p>在python中访问PyFrameObject对象：python中的 fram Object是对python源码中PyFrameObject结构体的包装。可以通过sys模块中的_getframe方法来获得当前处于活动状态的frame object。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">value = <span class="number">3</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">g</span><span class="params">()</span>:</span></span><br><span class="line">    frame = sys._getframe()</span><br><span class="line">    <span class="comment"># get current function name</span></span><br><span class="line">    print(<span class="string">"current function is "</span>, frame.f_code.co_name)</span><br><span class="line">    caller = frame.f_back</span><br><span class="line">    print(<span class="string">"caller function is "</span>, caller.f_code.co_name)</span><br><span class="line">    print(<span class="string">"caller's local namespace"</span>, caller.f_locals)</span><br><span class="line">    print(<span class="string">"caller's global namespace"</span>, caller.f_globals.keys())</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span><span class="params">()</span>:</span></span><br><span class="line">    a = <span class="number">1</span></span><br><span class="line">    b = <span class="number">2</span></span><br><span class="line">    g()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">    f()</span><br><span class="line">show()</span><br></pre></td></tr></table></figure>

<p>输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(&#39;current function is &#39;, &#39;g&#39;)</span><br><span class="line">(&#39;caller function is &#39;, &#39;f&#39;)</span><br><span class="line">(&quot;caller&#39;s local namespace&quot;, &#123;&#39;a&#39;: 1, &#39;b&#39;: 2&#125;)</span><br><span class="line">(&quot;caller&#39;s global namespace&quot;, [&#39;g&#39;, &#39;f&#39;, &#39;__builtins__&#39;, &#39;__file__&#39;, &#39;show&#39;, &#39;value&#39;, &#39;__package__&#39;, &#39;sys&#39;,&#39;__name__&#39;, &#39;__doc__&#39;])</span><br></pre></td></tr></table></figure>

<h4 id="3-python运行环境初始化"><a href="#3-python运行环境初始化" class="headerlink" title="3 python运行环境初始化"></a>3 python运行环境初始化</h4><h4 id="3-1-线程环境初始化"><a href="#3-1-线程环境初始化" class="headerlink" title="3.1 线程环境初始化"></a>3.1 线程环境初始化</h4><ul>
<li>在python启动的时候，会依次创建代表进程和线程的c结构体，并在他们之间建立联系;</li>
<li>之后，开始设置系统的module, 其中第一个被创建的module是<strong>buildin</strong> module</li>
<li>在某个名字空间中，找到某个符号所对应的对象</li>
</ul>
<blockquote>
<p>参考<br>《python源码剖析》</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/17/burpsuite%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cody">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="人生识字忧患始，不待扬鞭自奋蹄">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/03/17/burpsuite%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">burpsuite使用</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2019-03-17 12:43:26 / Modified: 12:44:45" itemprop="dateCreated datePublished" datetime="2019-03-17T12:43:26+08:00">2019-03-17</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" itemprop="url" rel="index">
                    <span itemprop="name">渗透测试</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/13/mysql%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cody">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="人生识字忧患始，不待扬鞭自奋蹄">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/03/13/mysql%E6%80%BB%E7%BB%93/" class="post-title-link" itemprop="url">mysql总结</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-03-13 09:36:59" itemprop="dateCreated datePublished" datetime="2019-03-13T09:36:59+08:00">2019-03-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-02-19 12:10:38" itemprop="dateModified" datetime="2020-02-19T12:10:38+08:00">2020-02-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%8E%E5%8F%B0%E5%BC%80%E5%8F%91/" itemprop="url" rel="index">
                    <span itemprop="name">后台开发</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="1-mysql查询基础"><a href="#1-mysql查询基础" class="headerlink" title="1 mysql查询基础"></a>1 mysql查询基础</h2><h3 id="1-1-单个表的检索"><a href="#1-1-单个表的检索" class="headerlink" title="1.1 单个表的检索"></a>1.1 单个表的检索</h3><h4 id="列的选择"><a href="#列的选择" class="headerlink" title="列的选择"></a>列的选择</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> column1_name, column2_name, ....</span><br><span class="line"><span class="keyword">from</span> table_name;</span><br></pre></td></tr></table></figure>

<h4 id="行的选择"><a href="#行的选择" class="headerlink" title="行的选择"></a>行的选择</h4><p><strong>选择值不同的行</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> column_name </span><br><span class="line"><span class="keyword">from</span> table_name;</span><br></pre></td></tr></table></figure>
<p><strong>限制行数</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * </span><br><span class="line"><span class="keyword">from</span> table_name</span><br><span class="line"><span class="keyword">limit</span> <span class="number">10</span>, <span class="number">5</span>; // 开始行和行数</span><br></pre></td></tr></table></figure>

<h4 id="排序数据"><a href="#排序数据" class="headerlink" title="排序数据"></a>排序数据</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * </span><br><span class="line"><span class="keyword">from</span> table_name</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> column_name <span class="keyword">desc</span>;  // 单个列排序降序，升序是默认的</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * </span><br><span class="line"><span class="keyword">from</span> table_name</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> column_name1 <span class="keyword">desc</span>, column_name2 <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>

<h4 id="过滤"><a href="#过滤" class="headerlink" title="过滤"></a>过滤</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> table_name</span><br><span class="line"><span class="keyword">where</span> column_name1=<span class="string">"cody"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> table_name</span><br><span class="line"><span class="keyword">where</span> column_name1 <span class="keyword">is</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>

<h4 id="时间和日期处理"><a href="#时间和日期处理" class="headerlink" title="时间和日期处理"></a>时间和日期处理</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> table_name</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">Year</span>(column_name) = <span class="number">2005</span> <span class="keyword">and</span> <span class="keyword">Month</span>(column_name) = <span class="number">9</span>;</span><br></pre></td></tr></table></figure>

<h4 id="汇总数据"><a href="#汇总数据" class="headerlink" title="汇总数据"></a>汇总数据</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*)</span><br><span class="line">from table_name; // count(*)会计算null值，count(column_name)不会计算null值</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">sum</span>(column_name)</span><br><span class="line"><span class="keyword">from</span> table_name;</span><br></pre></td></tr></table></figure>

<h4 id="分组数据"><a href="#分组数据" class="headerlink" title="分组数据"></a>分组数据</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> vend_id, <span class="keyword">count</span>(*) <span class="keyword">as</span> <span class="keyword">num</span></span><br><span class="line"><span class="keyword">from</span> table_name</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> vend_id;  // 分组</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> customer_id, <span class="keyword">count</span>(*) <span class="keyword">as</span> <span class="keyword">num</span></span><br><span class="line"><span class="keyword">from</span> orders</span><br><span class="line"><span class="keyword">where</span> price &gt; <span class="number">2</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> customer_id</span><br><span class="line"><span class="keyword">having</span> <span class="keyword">count</span>(*) &gt;= <span class="number">2</span>  // <span class="keyword">having</span>对分组进行过滤，<span class="keyword">where</span>对行进行过滤</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> customer_id</span><br><span class="line"><span class="keyword">limit</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h4 id="子查询"><a href="#子查询" class="headerlink" title="子查询"></a>子查询</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> cust_id</span><br><span class="line"><span class="keyword">from</span> orders</span><br><span class="line"><span class="keyword">where</span> order_num <span class="keyword">in</span> (<span class="keyword">select</span> order_num <span class="keyword">from</span> orderitems <span class="keyword">where</span> prod_id=<span class="string">'TNT'</span>);  // 子查询由内向外执行</span><br></pre></td></tr></table></figure>

<h3 id="1-2-多个表的检索"><a href="#1-2-多个表的检索" class="headerlink" title="1.2 多个表的检索"></a>1.2 多个表的检索</h3><h4 id="内连接"><a href="#内连接" class="headerlink" title="内连接"></a>内连接</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> vend_name, prod_name, prod_price</span><br><span class="line"><span class="keyword">from</span> vendors, products</span><br><span class="line">where vendors.vend_id = products.vend_id; // 不使用连接条件的表关系返回笛卡尔积，第一个表中的行数*第二个表中的行数</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> vend_name, prod_name, prod_price</span><br><span class="line"><span class="keyword">from</span> vendors <span class="keyword">inner</span> <span class="keyword">join</span> products <span class="keyword">on</span> vendor.id=products.vendor_id;  // 与上面的效果一样</span><br></pre></td></tr></table></figure>
<h4 id="自连接"><a href="#自连接" class="headerlink" title="自连接"></a>自连接</h4><p>自己连接自己</p>
<h4 id="外连接"><a href="#外连接" class="headerlink" title="外连接"></a>外连接</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> table_name1 <span class="keyword">left</span> <span class="keyword">join</span> table_name2</span><br><span class="line"><span class="keyword">on</span> table_name1.column_name = table_name2.column_name;</span><br></pre></td></tr></table></figure>


<h3 id="1-3-组合查询"><a href="#1-3-组合查询" class="headerlink" title="1.3 组合查询"></a>1.3 组合查询</h3><p>union查询</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> column1, column2</span><br><span class="line"><span class="keyword">from</span> table_name1</span><br><span class="line"><span class="keyword">where</span> column1 &lt; <span class="number">10</span>;</span><br><span class="line">union</span><br><span class="line"><span class="keyword">select</span> column1, column2</span><br><span class="line"><span class="keyword">from</span> table_name1</span><br><span class="line"><span class="keyword">where</span> column2 = <span class="number">20</span>;</span><br></pre></td></tr></table></figure>




<h3 id="1-4-创建表"><a href="#1-4-创建表" class="headerlink" title="1.4 创建表"></a>1.4 创建表</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> table_name(</span><br><span class="line">    customer_id <span class="built_in">int</span> <span class="keyword">not</span> <span class="literal">null</span> auto_increment,</span><br><span class="line">    customer_name <span class="built_in">char</span>(<span class="number">50</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    primary <span class="keyword">key</span> (customer_id)</span><br><span class="line">) <span class="keyword">engine</span>=<span class="keyword">innodb</span>;</span><br></pre></td></tr></table></figure>

<h4 id="更新表"><a href="#更新表" class="headerlink" title="更新表"></a>更新表</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> table_name</span><br><span class="line"><span class="keyword">add</span> vend_phone <span class="built_in">char</span>(<span class="number">20</span>); // 添加一列</span><br><span class="line"></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> table_name</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">column</span> vend_phone; // 删除一列</span><br></pre></td></tr></table></figure>

<h2 id="2-事务"><a href="#2-事务" class="headerlink" title="2 事务"></a>2 事务</h2><p>事务的目的：事务会把数据库从一种一致状态转换为另一种一致状态。事务的特性有如下：ACID。</p>
<ul>
<li>原子性： redo log重做日志实现。</li>
<li>一致性: undo log来实现。</li>
<li>隔离性: 通过锁来实现。</li>
<li>持久性: redo log实现。</li>
</ul>
<h3 id="2-1-事务的隔离级别"><a href="#2-1-事务的隔离级别" class="headerlink" title="2.1 事务的隔离级别"></a>2.1 事务的隔离级别</h3><p>InnoDB默认的隔离级别是READ REPEATABLE</p>
<ul>
<li>read uncommited: 事务2读取到事务1未提交的数据, 脏读</li>
<li>read comitted: 事务2读取到事务1已提交的数据，造成不可重复读</li>
<li>repeatable read： 造成幻读。</li>
<li>serializable：此隔离级别是，每个select语句都会自动加上一个共享锁，此时对一致性的非锁定读不再支持。</li>
</ul>
<h3 id="2-2-事务日志"><a href="#2-2-事务日志" class="headerlink" title="2.2 事务日志"></a>2.2 事务日志</h3><h4 id="redo-log"><a href="#redo-log" class="headerlink" title="redo log"></a>redo log</h4><p>redo由两部分组成：</p>
<ul>
<li>内存中的重做日志缓冲</li>
<li>日志文件</li>
</ul>
<p>InnoDB在<strong>事务提交</strong>的时候，必须将事务的所有日志写入到redo日志文件。为了保证每次日志都写入重做日志文件，在每次将<strong>重做日志缓冲</strong>写入重做日志文件后，InnoDB存储引擎都会调用一次<code>fsync</code>系统调用，因为这时的写入可能在文件系统缓存中该系统调用将数据刷新到磁盘上。</p>
<p>如果在事务每次提交的时候都进行<code>fsync</code>系统调用会影响性能，所以InnoDB允许设置<code>fsync</code>调用的时机来控制重做日志刷新到磁盘上的策略。使用<code>innodb_flush_log_at_trx_commit</code>参数来实现，参数的值有如下：</p>
<ul>
<li>0, 表示事务提交时，不进行写入重做日志操作</li>
<li>1， 默认值，表示事务提交时，必须进行一次fsync操作。</li>
<li>2, 表示事务提交时将重做日志写入到日志文件中，但是仅写入到文件系统的缓存中，不进行fsync操作。</li>
</ul>
<p>redo log基本上都是顺序写的，数据库运行时不需要对该日志进行读写操作。</p>
<p><strong>redo log和binlo的区别</strong></p>
<ul>
<li>redo是存储引擎层面的，binlog是MySQL层面的</li>
<li>binlog是一种逻辑日志，记录的是对应的SQL语句，redo log是物理格式，记录的是每个页的修改</li>
<li>两种日志写入磁盘的时间点不同。binlog在事务提交完成后一次性写入，redolog是事务进行中。</li>
</ul>
<h4 id="undo-log"><a href="#undo-log" class="headerlink" title="undo log"></a>undo log</h4><p>redo log存放在日志文件中，undo log存放在数据库内部的一个特殊段中，这个段叫做undo段，位于共享表空间内。undo是逻辑日志，可以将数据库恢复到执行事务之前的样子。</p>
<p>另外，InnoDB的多版本并发控制(MVVC)也是通过undo实现的。</p>
<p>undo会产生redo log</p>
<h3 id="2-3-事务控制语句"><a href="#2-3-事务控制语句" class="headerlink" title="2.3 事务控制语句"></a>2.3 事务控制语句</h3><p>在mysql命令行，默认设置的事务是自动提交的。</p>
<h3 id="undo"><a href="#undo" class="headerlink" title="undo"></a>undo</h3><h2 id="3-索引"><a href="#3-索引" class="headerlink" title="3 索引"></a>3 索引</h2><p>根据键值，快速的找到数据。</p>
<h3 id="B-树"><a href="#B-树" class="headerlink" title="B+树"></a>B+树</h3><p>非叶子节点存放的是key， 叶子节点存放的是{key: data}.在B+树中，所有的记录节点都是按键值的大小，顺序存放在同一层的叶子节点上，由各叶子节点指针连接。在数据库中B+树的高度一般为2-4层。也就是说查找某一键值的行记录最多需要2到4次的IO。</p>
<h3 id="MyISAM索引"><a href="#MyISAM索引" class="headerlink" title="MyISAM索引"></a>MyISAM索引</h3><p>MyISAM引擎使用B+Tree作为索引结构，叶节点的data域存放的是<strong>数据记录的地址</strong>, 对于主索引和辅助索引都是如此。索引可以分为</p>
<ul>
<li>主索引: 主键对应的索引,要求key唯一</li>
<li>辅助索引：非主键对应的索引，key可以重复</li>
</ul>
<p>索引文件和行记录文件是分开的。</p>
<h3 id="InnoDB索引"><a href="#InnoDB索引" class="headerlink" title="InnoDB索引"></a>InnoDB索引</h3><p>InnoDB中的索引可以分为：</p>
<ul>
<li>聚集索引: 按照每张表的<strong>主键</strong>构造一颗B+树，同时叶子节点存放的是整张表的<strong>行记录数据</strong>。</li>
<li>辅助索引: 叶子节点不包含行记录的全部数据而是相应记录<strong>主键的值</strong>, 每张表上可以有多个辅助索引。当通过辅助索引来查找数据的时候，Innodb存储引擎会遍历辅助索引并通过叶子节点中的指针获取指向主键索引的主键，然后在通过主键索引来查找一个完整的记录。</li>
</ul>
<p>InnoDB中聚集索引文件和数据文件是同一个文件。数据文件本身就是要按照主键进行聚集，innodb要求表必须有主键，如果没有显示的指定，Innodb会自动选择一个可以唯一标识数据记录的列作为主键，如果不存在这种列，则MySQL自动为InnoDB表生成一个隐含字段作为主键，这个字段长度为6个字节，类型为长整型。</p>
<h2 id="4-InnoDB引擎中的锁"><a href="#4-InnoDB引擎中的锁" class="headerlink" title="4 InnoDB引擎中的锁"></a>4 InnoDB引擎中的锁</h2><p><img src="mysql%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E5%B1%82%E6%AC%A1%E7%BB%93%E6%9E%84.png" alt="MySQL数据存储的层次结构"></p>
<p>锁机制是用于管理对<strong>共享资源</strong>的并发访问。InnoDB会在行级别上对表数据上锁。</p>
<p>在InnoDB中的锁有: </p>
<ul>
<li>latch: 可以分为mutex和rwlock。其目的是用来保证并发线程操作临界资源的正确定。</li>
<li>lock: lock的对象是事务, 用来锁定的是数据库中的对象，如表、页、行<ul>
<li>共享锁(S lock): 行级锁，允许事务读一行数据. </li>
<li>排他锁(X lock): 行级锁, 允许事务删除或者更新一行数据</li>
</ul>
</li>
</ul>
<p><strong>一致性非锁定读</strong></p>
<ol>
<li>如果事务1和事务2同时获取同一行的共享锁。如果事务3想要获取该行的排它锁，需要等待事务1和事务2释放该行上的共享锁。</li>
<li>如果事务1得到了某一行上的排他锁，此时事务2想要获取该行的共享锁，这时事务2不会等待事务1释放在该行上的排它锁，而是会读取行的一个<strong>快照数据</strong>(所谓的快照数据，是指改行的之前版本的数据)，称为一致性的非锁定读。非锁读可以极大的提高数据库的并发性。</li>
</ol>
<p><strong>一致性的锁定读</strong></p>
<p>所谓的锁定读，就是事务1得到了某行的排它锁，此时事务2想要获取该行的共享锁读取该行数据，此时事务2需要等待在该行上的排它锁的释放。</p>
<p>InnoDB引擎对select语句支持两种一致性的锁定读：</p>
<ul>
<li>select….. for update; 对读取的行加一个x锁，其它的事务不能对锁定的行加任何锁。</li>
<li>select  …… lock in share mode; 对读取的行记录加一个s锁。其他事务可以对被锁定的行加s锁，但是如果加x锁，就会被阻塞。</li>
</ul>
<p><strong>自增长</strong></p>
<p>每个含有自增长值的表都有一个自增长计数器，当对这种表进行插入操作时，这个计数器会被初始化。在这里使用了一种特殊的表锁机制，锁不会在事务完成后才释放，而是完成对自增长值插入的sql语句后立即释放。</p>
<p>InnoDB存储引擎中，自增长值的列必须是索引，同时必须是索引的第一个列。</p>
<h2 id="5-架构"><a href="#5-架构" class="headerlink" title="5 架构"></a>5 架构</h2><p><img src="mysql%E6%9E%B6%E6%9E%84.png" alt="MySQL架构"></p>
<ul>
<li>最上层的连接服务，用于不同语言与SQL的交互。可以通过<code>show variables like &#39;%connections%&#39;</code>命令查看MySQL实例的最大连接数和单个用户的最大连接数。</li>
<li>第二层MySQL Server，大多数MySQL的核心服务功能都在这一层，包括查询解析、分析、优化、缓存，所有跨存储引擎的功能都集中在这一层实现。<ul>
<li><strong>Management Services &amp; Utilities</strong>：系统管理和控制工具，备份和恢复的安全性，复制，集群，管理，配置，迁移和元数据。</li>
<li><strong>Connection Pool</strong>：连接池，进行身份验证、线程重用，连接限制，检查内存，数据缓存；管理用户的连接，线程处理等需要缓存的需求。</li>
<li><strong>SQL Interface</strong>：SQL 接口，进行 DML、DDL，存储过程、视图、触发器等操作和管理，用户通过 SQL 命令来查询所需结果。</li>
<li><strong>Parser</strong>：解析器；查询翻译对象的特权，SQL 命令传递到解析器的时候会被解析器验证和解析。</li>
<li><strong>Optimizer</strong>：查询优化器。</li>
<li><strong>Cache 和 Buffer</strong>：查询缓存，全局和引擎特定的缓存和缓冲区。</li>
</ul>
</li>
<li>第三层为存储引擎层，存储引擎负责MySQL中数据的存储和提取，服务器通过API于存储引擎进行通信。可以通过<code>SHOW ENGINES</code>命令查看各个存储引擎信息。</li>
</ul>
<h2 id="6-优化"><a href="#6-优化" class="headerlink" title="6 优化"></a>6 优化</h2><h3 id="库表结构优化"><a href="#库表结构优化" class="headerlink" title="库表结构优化"></a>库表结构优化</h3><p><strong>字段类型选择</strong></p>
<p>尽量使用整数来表示字符串：整型的优势（存储空间固定，运算速度快）;<br>字符串类型的选择: char, varchar, text的确定：varchar占用字段的总空间，text不占用字段的总空间，数据独立存储，字段的总空间是有限的默认为65535字节；</p>
<ul>
<li>尽可能选择小的数据类型</li>
<li>尽可能使用not null<ul>
<li>非空字段的处理，要比空字段的处理效率高，null的存储需要额外的空间，运算也需要特殊的运算符</li>
<li>null参与常规运算结果就是null，除非使用is null 和 is not null</li>
<li>在mysql中的每条记录会使用额外的存储空间，表示每个字段是否为null</li>
<li>对于要设置为空的字段我们常使用一个占位符来处理</li>
</ul>
</li>
</ul>
<p><strong>分库分表优化</strong></p>
<h3 id="索引优化"><a href="#索引优化" class="headerlink" title="索引优化"></a>索引优化</h3><p><strong>最左前缀</strong></p>
<p><strong>多列索引</strong></p>
<h3 id="查询优化"><a href="#查询优化" class="headerlink" title="查询优化"></a>查询优化</h3><p><img src="sql%E8%AF%AD%E5%8F%A5%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B.png" alt="查询执行"></p>
<p>在MySQL Server中首先有一个 Cache，用来缓存 SQL 查询语句的查询结果，如果缓存命中，则直接返回结果，如果缓存没有命中，则对 SQL 语句进行语法分析，预处理和查询优化，最终得到该查询的执行计划，之后，该执行计划被送往数据库引擎, 调用存储引擎的API来执行查询，得到最终查询到的数据。数据库引擎并不会严格按照执行计划进行执行，而是会根据自身的架构和特性进行一些调整，以提高执行效率。多数连接MySQL的库函数都可以获取服务器响应的全部结果集并缓存到内存中。MySQL在将所有的数据发送给客户端之后才会释放这条查询所占用的资源。接收全部服务器返回的结果可以减少服务器的压力。</p>
<p>首先应该清楚一点即查询是由许多的子任务组成的，所谓的优化就是优化这些子任务，要么消除一些子任务，要么减少子任务的执行次数，要么让子任务运行的更快。那么问题来了，mysql在执行查询的时候有哪些子任务呢？哪些子任务运行的慢呢？</p>
<p>通常来说一条查询大致的子任务有如下：从客户端，到服务器，然后在服务器上进行解析，生成执行计划，执行，并返回结果给客户端。在完成这些任务的时候，查询需要在不同的地方花费时间，包括：网络、CPU计算、生成统计信息和执行计划、锁等待等操作，尤其是向底层的存储引擎检索数据的调用操作。优化查询的目的就是减小和消除这些操作所花费的时间。</p>
<p>查询性能低下的最基本原因是访问的数据太多。对于查询慢的，我们可以从以下两个方面考虑：</p>
<ul>
<li>应用程序是否请求了大量不需要的数据；</li>
<li>服务器为了返回结果是否扫描了大量没用的数据行（响应时间、扫描的行数、返回的行数，这三个指标都会记录到MySQL的慢日志中）。</li>
</ul>
<p><strong>慢查询日志</strong></p>
<p><strong>响应时间</strong></p>
<p>响应时间：服务时间+等待时间；服务时间是指数据库处理这个查询真正花费的时间。排队时间是指因为服务器因为等待某些资源而没有真正执行查询的时间-可能是等待IO操作完成，也可能是等待行锁。快速上限法估计响应时间（了解这个查询需要哪些索引以及它的执行计划是什么，然后计算大概需要多少个顺序和随机IO，再乘以具体硬件条件下一次IO的消耗时间）。</p>
<p><strong>扫描行数和返回行数</strong></p>
<p>理想情况下，扫描的行数和返回的行数应该是相同的。但是实际中，扫描的行数：返回的行数一般在1：1和10：1之间。扫描的行数可以在explain结果中的row列预估出来。</p>
<p>MySQL从表中找到某一行数据的成本。MySQL有好几种访问方式可以查找并返回一行结果。访问方式可以在explain语句中的type列反映了扫描类型：</p>
<ul>
<li>全表扫描(ALL，通过读物理表获取数据，顺序读磁盘文件), 从头到尾去找需要的行</li>
<li>索引全扫描(index，查询时遍历索引树来扫描，如果数据不是密集的会产生随机io), 这个跟全表扫描一样，只是在扫描表的时候按索引次序进行，而不是按照行</li>
<li>范围扫描(range),它从索引里的某一个点开始，返回匹配这个值域的行。当mysql去查找一系列值的时候入in(）和or（）列表。此类扫描的开销跟索引类型相当</li>
<li>唯一索引查询(ref)</li>
<li>常数引用(const)等</li>
</ul>
<h2 id="7-高可用架构"><a href="#7-高可用架构" class="headerlink" title="7 高可用架构"></a>7 高可用架构</h2><h3 id="主从架构"><a href="#主从架构" class="headerlink" title="主从架构"></a>主从架构</h3><p><img src="mysql%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84.png" alt="高可用架构"></p>
<p><strong>主从复制的基本流程</strong></p>
<p>slave订阅master的binlog。</p>
<ol>
<li>Slave上面的IO进程连接上Master，并请求从指定日志文件的指定位置（或者从最开始的日志）之后的日志内容。</li>
<li>Master接收到来自Slave的IO进程的请求后，负责复制的IO进程会根据请求信息读取日志指定位置之后的日志信息，返回给Slave的IO进程。返回信息中除了日志所包含的信息之外，还包括本次返回的信息已经到Master端的bin-log文件的名称以及bin-log的位置。</li>
<li>Slave的IO进程接收到信息后，将接收到的日志内容依次添加到Slave端的relay-log文件的最末端，并将读取到的Master端的 bin-log的文件名和位置记录到master-info文件中，以便在下一次读取的时候能够清楚的告诉Master“我需要从某个bin-log的哪个位置开始往后的日志内容，请发给我”。</li>
<li>Slave的Sql进程检测到relay-log中新增加了内容后，会马上解析relay-log的内容成为在Master端真实执行时候的那些可执行的内容，并在自身执行。</li>
</ol>
<p><strong>一主多从复制复制</strong></p>
<p>如果一主多从的话，这时主库既要负责写又要负责为几个从库提供二进制日志。此时可以稍做调整，将二进制日志只给某一从，这一从再开启二进制日志并将自己的二进制日志再发给其它从。或者是干脆这个从不记录只负责将二进制日志转发给其它从，这样架构起来性能可能要好得多，而且数据之间的延时应该也稍微要好一些。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><blockquote>
<p>《MySQL必知必会》<br>《高性能MySQL》<br>《MySQL技术内幕-InnoDB存储引擎》</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/10/nginx%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cody">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="人生识字忧患始，不待扬鞭自奋蹄">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/03/10/nginx%E9%85%8D%E7%BD%AE/" class="post-title-link" itemprop="url">nginx配置</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-03-10 09:48:06" itemprop="dateCreated datePublished" datetime="2019-03-10T09:48:06+08:00">2019-03-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-04-20 18:07:43" itemprop="dateModified" datetime="2019-04-20T18:07:43+08:00">2019-04-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%8E%E5%8F%B0%E5%BC%80%E5%8F%91/" itemprop="url" rel="index">
                    <span itemprop="name">后台开发</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="1-版本介绍"><a href="#1-版本介绍" class="headerlink" title="1 版本介绍"></a>1 版本介绍</h2><ul>
<li>开发版</li>
<li>稳定版</li>
<li>历史版</li>
</ul>
<h2 id="2-安装"><a href="#2-安装" class="headerlink" title="2 安装"></a>2 安装</h2><ul>
<li>首先安装依赖包 <code>libpcre3</code>（解析正则的库） <code>libpcre3-dev</code> <code>zlib1g-dev</code></li>
<li>下载nginx包</li>
<li>安装nginx</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./config  生成makefiel</span><br><span class="line">make 编译文件</span><br><span class="line">make install 安装</span><br></pre></td></tr></table></figure>

<h2 id="3-功能"><a href="#3-功能" class="headerlink" title="3 功能"></a>3 功能</h2><h2 id="4-配置解读"><a href="#4-配置解读" class="headerlink" title="4 配置解读"></a>4 配置解读</h2><h2 id="5-nginx的日志类型"><a href="#5-nginx的日志类型" class="headerlink" title="5 nginx的日志类型"></a>5 nginx的日志类型</h2><ul>
<li>error.log</li>
<li>access.log</li>
</ul>
<h3 id="错误日志的配置"><a href="#错误日志的配置" class="headerlink" title="错误日志的配置"></a>错误日志的配置</h3><h3 id="nginx中有哪些变量"><a href="#nginx中有哪些变量" class="headerlink" title="nginx中有哪些变量"></a>nginx中有哪些变量</h3><ul>
<li><p>请求的变量</p>
</li>
<li><p>需求，我们想要记录用户的user-agent，应该怎么处理</p>
<ul>
<li>request的请求变量是http_请求头信息，如http_user_agent</li>
</ul>
</li>
<li><p>nginx -c -t config  检查配置文件的配置是否正确</p>
</li>
</ul>
<h2 id="不同场景下的配置"><a href="#不同场景下的配置" class="headerlink" title="不同场景下的配置"></a>不同场景下的配置</h2><h2 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h2><h3 id="http请求"><a href="#http请求" class="headerlink" title="http请求"></a>http请求</h3><ul>
<li>curl -v <a href="http://ww.baidu.com" target="_blank" rel="noopener">http://ww.baidu.com</a>  # 详细的查看每次的请求信息</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Cody</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">49</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">38</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/mxiaole" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;mxiaole" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/mengjiale6@126.com" title="E-Mail → mengjiale6@126.com"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Cody</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> v4.2.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.7.1
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
